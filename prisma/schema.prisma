// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// --- üîê ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ---
model User {
  id               Int      @id @default(autoincrement())
  username         String   @unique
  password         String
  fullName         String
  email            String   @unique
  position         String?
  phoneNumber      String?
  isActive         Boolean  @default(true)
  role             Role     @relation(fields: [roleId], references: [id])
  roleId           Int
  department       Department? @relation(fields: [departmentId], references: [id])
  departmentId     Int?     // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin, Final Approver (‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
  
  // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Permissions)
  accessibleCategories Category[] 
  
  // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
  auditLogs              AuditLog[]
  requests               ITRequestF07[] @relation("Requester")
  specialApproverMappings SpecialApproverMapping[]
  
  // Relations for History
  approvalHistory        ApprovalHistory[]
  notifications          Notification[]
}

model Role {
  id               Int      @id @default(autoincrement())
  roleName         String   @unique // Admin, User, Head of Department
  description      String?  // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•) ‚Äî ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
  allowBulkActions Boolean  @default(false)
  users            User[]
  
  // Relations for Workflow
  transitions      WorkflowTransition[]
}

// --- üìã ‡∏£‡∏∞‡∏ö‡∏ö Master Data ---
model Status {
  id          Int     @id @default(autoincrement())
  code        String  @unique // PENDING, PENDING_HOD, CLOSED, ...
  displayName String  // ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
  colorCode   String  @default("#6b7280") 
  displayOrder Int    @default(0)
  isInitialState Boolean @default(false) // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

  requests        ITRequestF07[]
  transitionsFrom WorkflowTransition[] @relation("CurrentStatus")
  transitionsTo   WorkflowTransition[] @relation("NextStatus")
}

model Action {
  id          Int     @id @default(autoincrement())
  actionName  String  @unique // APPROVE, REJECT, IT_PROCESS, CONFIRM_COMPLETE
  displayName String  // ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥, ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò, ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  
  transitions WorkflowTransition[]
}

model Department {
  id             Int      @id @default(autoincrement())
  name           String   @unique
  isActive       Boolean  @default(true)
  users          User[]
  requests       ITRequestF07[]
}

model Location {
  id             Int      @id @default(autoincrement())
  name           String   @unique
  categories     Category[] 
  requests       ITRequestF07[]
}

model Category {
  id                      Int      @id @default(autoincrement())
  name                    String   @unique
  requiresCCSClosing     Boolean  @default(false)
  locations               Location[]
  users                   User[]   
  
  // Relations
  requests                ITRequestF07[]
  docConfigs              DocConfig[]
  correctionTypes         CorrectionType[]
  
  // Config
  workflowSteps           WorkflowStep[] // Deprecated but kept for migration if needed
  transitions             WorkflowTransition[]
  specialApproverMappings SpecialApproverMapping[]
}

model CorrectionReason {
  id        Int     @id @default(autoincrement())
  text      String  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
  isActive  Boolean @default(true)
}

model CorrectionType {
  id             Int       @id @default(autoincrement())
  name           String    @unique
  displayOrder   Int       @default(10)
  isActive       Boolean   @default(true)
  templateString String?   
  fieldsConfig   String?   
  categories     Category[]
  
  // Relations
  requestCorrectionTypes RequestCorrectionType[]
  transitions            WorkflowTransition[]
}

// --- ‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö Workflow & Config (State Machine) ---

model WorkflowTransition {
  id                Int      @id @default(autoincrement())
  categoryId        Int
  correctionTypeId  Int?     // Nullable: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Null ‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏é‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General)
  currentStatusId   Int
  actionId          Int
  requiredRoleId    Int
  nextStatusId      Int
  stepSequence      Int      // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡∏´‡∏£‡∏∑‡∏≠ Parallel Check
  filterByDepartment Boolean @default(false)
  
  category        Category       @relation(fields: [categoryId], references: [id])
  correctionType  CorrectionType? @relation(fields: [correctionTypeId], references: [id])
  currentStatus   Status         @relation("CurrentStatus", fields: [currentStatusId], references: [id])
  action          Action         @relation(fields: [actionId], references: [id])
  requiredRole    Role           @relation(fields: [requiredRoleId], references: [id])
  nextStatus      Status         @relation("NextStatus", fields: [nextStatusId], references: [id])
}

// Kept for backward compatibility/reference, map to Transitions instead
model WorkflowStep {
  id                  Int      @id @default(autoincrement())
  stepSequence        Int      
  approverRoleName    String   
  filterByDepartment  Boolean  @default(false) 
  categoryId          Int
  category            Category @relation(fields: [categoryId], references: [id])
}

model SpecialApproverMapping {
  id            Int      @id @default(autoincrement())
  categoryId    Int
  stepSequence  Int
  userId        Int
  category      Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([categoryId, stepSequence])
}

model DocConfig {
  id                 Int      @id @default(autoincrement())
  year               Int      
  prefix             String   
  lastRunningNumber  Int      @default(0)
  categoryId         Int
  category           Category @relation(fields: [categoryId], references: [id])
}

model EmailTemplate {
  id           Int     @id @default(autoincrement())
  templateName String  @unique // ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏ä‡πà‡∏ô APPROVAL_NOTIFY, REVISION
  description  String? // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
  subject      String  // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•
  body         String  @default("") // ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ HTML
  placeholders String  @default("") // ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma ‡πÄ‡∏ä‡πà‡∏ô {{requestId}}, {{requestNumber}}
}

// --- üìù ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á F07 (Core Transaction) ---
model ITRequestF07 {
  id              Int      @id @default(autoincrement())
  workOrderNo     String?  @unique
  thaiName        String   
  phone           String?   
  problemDetail   String
  systemType      String   
  isMoneyRelated  Boolean  @default(false)
  attachmentPath  String?  
  
  // Status Management
  status          String?  @default("PENDING") // Legacy string status (Deprecated)
  currentStatusId Int      @default(1) // Default to initial status (needs seed)
  currentStatus   Status   @relation(fields: [currentStatusId], references: [id])
  
  currentApprovalStep Int   @default(1) // Legacy step (Deprecated)
  approvalToken   String?  @unique             
  
  // New Fields
  reasonText      String?
  problemReason   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  requester       User     @relation("Requester", fields: [requesterId], references: [id])
  requesterId     Int
  department      Department @relation(fields: [departmentId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  departmentId    Int
  location        Location @relation(fields: [locationId], references: [id])
  locationId      Int
  category        Category @relation(fields: [categoryId], references: [id])
  categoryId      Int
  
  auditLogs       AuditLog[]
  correctionTypes RequestCorrectionType[]
  approvalHistory ApprovalHistory[] // Relation to history
  notifications   Notification[]
}

model RequestCorrectionType {
  requestId        Int
  correctionTypeId Int
  
  request          ITRequestF07   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  correctionType   CorrectionType @relation(fields: [correctionTypeId], references: [id], onDelete: Cascade)
  
  @@id([requestId, correctionTypeId])
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  timestamp   DateTime @default(now())
  action      String   
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id])
  ipAddress   String?
  detail      String?
  requestId   Int?
  request     ITRequestF07? @relation(fields: [requestId], references: [id], onDelete: SetNull)
}

model ApprovalHistory { 
  id              Int      @id @default(autoincrement())
  requestId       Int
  approverId      Int
  approvalLevel   Decimal  @default(0) // StepSequence
  actionType      String   // Approve, Reject
  comment         String?
  approvalTimestamp DateTime @default(now())
  
  request         ITRequestF07 @relation(fields: [requestId], references: [id], onDelete: Cascade) 
  approver        User         @relation(fields: [approverId], references: [id])
}



model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  requestId Int?
  request   ITRequestF07? @relation(fields: [requestId], references: [id], onDelete: SetNull)
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}