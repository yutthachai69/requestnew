generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      Int                      @id @default(autoincrement())
  username                String                   @unique
  password                String
  fullName                String
  email                   String                   @unique
  position                String?
  phoneNumber             String?
  isActive                Boolean                  @default(true)
  roleId                  Int
  departmentId            Int?
  approvalHistory         ApprovalHistory[]
  auditLogs               AuditLog[]
  requests                ITRequestF07[]           @relation("Requester")
  notifications           Notification[]
  specialApproverMappings SpecialApproverMapping[]
  department              Department?              @relation(fields: [departmentId], references: [id])
  role                    Role                     @relation(fields: [roleId], references: [id])
  accessibleCategories    Category[]               @relation("CategoryToUser")
}

model Role {
  id               Int                  @id @default(autoincrement())
  roleName         String               @unique
  description      String?
  allowBulkActions Boolean              @default(false)
  users            User[]
  transitions      WorkflowTransition[]
}

model Status {
  id              Int                  @id @default(autoincrement())
  code            String               @unique
  displayName     String
  colorCode       String               @default("#6b7280")
  displayOrder    Int                  @default(0)
  isInitialState  Boolean              @default(false)
  requests        ITRequestF07[]
  transitionsFrom WorkflowTransition[] @relation("CurrentStatus")
  transitionsTo   WorkflowTransition[] @relation("NextStatus")
}

model Action {
  id          Int                  @id @default(autoincrement())
  actionName  String               @unique
  displayName String
  transitions WorkflowTransition[]
}

model Department {
  id       Int            @id @default(autoincrement())
  name     String         @unique
  isActive Boolean        @default(true)
  requests ITRequestF07[]
  users    User[]
}

model Location {
  id         Int            @id @default(autoincrement())
  name       String         @unique
  requests   ITRequestF07[]
  categories Category[]     @relation("CategoryToLocation")
}

model Category {
  id                      Int                      @id @default(autoincrement())
  name                    String                   @unique
  requiresCCSClosing      Boolean                  @default(false)
  docConfigs              DocConfig[]
  requests                ITRequestF07[]
  specialApproverMappings SpecialApproverMapping[]
  workflowSteps           WorkflowStep[]
  transitions             WorkflowTransition[]
  correctionTypes         CorrectionType[]         @relation("CategoryToCorrectionType")
  locations               Location[]               @relation("CategoryToLocation")
  users                   User[]                   @relation("CategoryToUser")
}

model CorrectionReason {
  id       Int     @id @default(autoincrement())
  text     String
  isActive Boolean @default(true)
}

model CorrectionType {
  id                     Int                     @id @default(autoincrement())
  name                   String                  @unique
  displayOrder           Int                     @default(10)
  isActive               Boolean                 @default(true)
  templateString         String?
  fieldsConfig           String?
  requestCorrectionTypes RequestCorrectionType[]
  transitions            WorkflowTransition[]
  categories             Category[]              @relation("CategoryToCorrectionType")
}

model WorkflowTransition {
  id                 Int             @id @default(autoincrement())
  categoryId         Int
  correctionTypeId   Int?
  currentStatusId    Int
  actionId           Int
  requiredRoleId     Int
  nextStatusId       Int
  stepSequence       Int
  filterByDepartment Boolean         @default(false)
  action             Action          @relation(fields: [actionId], references: [id])
  category           Category        @relation(fields: [categoryId], references: [id])
  correctionType     CorrectionType? @relation(fields: [correctionTypeId], references: [id])
  currentStatus      Status          @relation("CurrentStatus", fields: [currentStatusId], references: [id])
  nextStatus         Status          @relation("NextStatus", fields: [nextStatusId], references: [id])
  requiredRole       Role            @relation(fields: [requiredRoleId], references: [id])
}

model WorkflowStep {
  id                 Int      @id @default(autoincrement())
  stepSequence       Int
  approverRoleName   String
  filterByDepartment Boolean  @default(false)
  categoryId         Int
  category           Category @relation(fields: [categoryId], references: [id])
}

model SpecialApproverMapping {
  id           Int      @id @default(autoincrement())
  categoryId   Int
  stepSequence Int
  userId       Int
  category     Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([categoryId, stepSequence])
}

model DocConfig {
  id                Int      @id @default(autoincrement())
  year              Int
  prefix            String
  lastRunningNumber Int      @default(0)
  categoryId        Int
  category          Category @relation(fields: [categoryId], references: [id])
}

model EmailTemplate {
  id           Int     @id @default(autoincrement())
  templateName String  @unique
  description  String?
  subject      String
  body         String  @default("")
  placeholders String  @default("")
}

model ITRequestF07 {
  id                  Int                     @id @default(autoincrement())
  workOrderNo         String?                 @unique
  thaiName            String
  phone               String?
  problemDetail       String
  systemType          String
  isMoneyRelated      Boolean                 @default(false)
  attachmentPath      String?
  status              String?                 @default("PENDING")
  currentStatusId     Int                     @default(1)
  currentApprovalStep Int                     @default(1)
  approvalToken       String?                 @unique
  reasonText          String?
  problemReason       String?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  requesterId         Int
  departmentId        Int
  locationId          Int
  categoryId          Int
  approvalHistory     ApprovalHistory[]
  auditLogs           AuditLog[]
  category            Category                @relation(fields: [categoryId], references: [id])
  currentStatus       Status                  @relation(fields: [currentStatusId], references: [id])
  department          Department              @relation(fields: [departmentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  location            Location                @relation(fields: [locationId], references: [id])
  requester           User                    @relation("Requester", fields: [requesterId], references: [id])
  notifications       Notification[]
  correctionTypes     RequestCorrectionType[]

  @@index([categoryId])
  @@index([createdAt])
  @@index([currentStatusId])
  @@index([departmentId])
  @@index([requesterId])
  @@index([status])
}

model RequestCorrectionType {
  requestId        Int
  correctionTypeId Int
  correctionType   CorrectionType @relation(fields: [correctionTypeId], references: [id], onDelete: Cascade)
  request          ITRequestF07   @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@id([requestId, correctionTypeId])
}

model AuditLog {
  id        Int           @id @default(autoincrement())
  timestamp DateTime      @default(now())
  action    String
  userId    Int?
  ipAddress String?
  detail    String?
  requestId Int?
  request   ITRequestF07? @relation(fields: [requestId], references: [id])
  user      User?         @relation(fields: [userId], references: [id])

  @@index([requestId])
  @@index([timestamp])
  @@index([userId])
}

model ApprovalHistory {
  id                Int          @id @default(autoincrement())
  requestId         Int
  approverId        Int
  approvalLevel     Decimal      @default(0)
  actionType        String
  comment           String?
  approvalTimestamp DateTime     @default(now())
  approver          User         @relation(fields: [approverId], references: [id])
  request           ITRequestF07 @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId, approvalLevel])
}

model Notification {
  id        Int           @id @default(autoincrement())
  userId    Int
  requestId Int?
  message   String
  isRead    Boolean       @default(false)
  createdAt DateTime      @default(now())
  request   ITRequestF07? @relation(fields: [requestId], references: [id])
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}
